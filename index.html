// 逆地理编码（高德API，需联网）+ 获取经纬度和海拔
let address = '';
let lat = '', lng = '', alt = '';
function getLocationAndAddress() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
            lat = pos.coords.latitude;
            lng = pos.coords.longitude;
            alt = pos.coords.altitude !== null ? pos.coords.altitude.toFixed(2) + ' 米' : '未获取到';
            // 保存到管理员标签
            document.getElementById('admin-tag').setAttribute('data-lat', lat);
            document.getElementById('admin-tag').setAttribute('data-lng', lng);
            document.getElementById('admin-tag').setAttribute('data-alt', alt);

            var key = '7450176ef6d80a3ba306437b0eb881ab';
            var url = `https://restapi.amap.com/v3/geocode/regeo?output=json&location=${lng},${lat}&key=${key}`;
            fetch(url).then(r=>r.json()).then(data=>{
                if(data.status==='1' && data.regeocode) {
                    address = data.regeocode.formatted_address || (lat+','+lng);
                } else {
                    address = lat+','+lng;
                }
                showAdminInfo();
            }).catch(()=>{
                address = lat+','+lng;
                showAdminInfo();
            });
        }, function(){
            address = '无法获取定位权限';
            lat = lng = alt = '';
            showAdminInfo();
        });
    } else {
        address = '浏览器不支持定位';
        lat = lng = alt = '';
        showAdminInfo();
    }
}
function showAdminInfo() {
    document.getElementById('addr-detail').innerText =
        `地址：${address}\n经度：${lng}\n纬度：${lat}\n海拔：${alt}`;
}

// 管理员弹窗逻辑
document.getElementById('admin-tag').onclick = function() {
    document.getElementById('admin-panel').style.display = 'block';
    document.getElementById('admin-login').style.display = '';
    document.getElementById('admin-addr').style.display = 'none';
    document.getElementById('admin-pwd').value = '';
    document.getElementById('admin-tip').innerText = '';
};
function checkPwd() {
    var pwd = document.getElementById('admin-pwd').value;
    if(pwd === '10314519') {
        document.getElementById('admin-login').style.display = 'none';
        document.getElementById('admin-addr').style.display = '';
        getLocationAndAddress();
    } else {
        document.getElementById('admin-tip').innerText = '密码错误';
    }
}
